<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KADAMAY Portal</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#008080">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- STYLES (Clean & Mobile Ready) --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-card { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; display: block; }
        .dashboard { display: none; width: 100%; max-width: 600px; height: 100vh; background: #f8f9fa; overflow-y: auto; position: relative; }
        .header { background: #008080; color: white; padding: 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 5px 15px rgba(0,128,128,0.3); position: relative; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-close { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 14px; padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        
        .btn-notif { position: relative; background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
        .badge-dot { position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background: #ff4757; border-radius: 50%; border: 2px solid #008080; display: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .profile-info h1 { margin: 0; font-size: 20px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .profile-info p { margin: 5px 0 0; opacity: 0.9; font-size: 14px; }
        .status-badge { display: inline-block; background: white; color: #008080; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .content { padding: 20px; padding-bottom: 80px; }
        .section-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-refresh { background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 8px; color: #666; cursor: pointer; font-size: 12px; font-weight: 600; }
        
        .payment-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .pay-left { display: flex; flex-direction: column; }
        .pay-date { font-size: 12px; color: #888; }
        .pay-or { font-weight: bold; color: #333; font-size: 14px; }
        .pay-right { font-weight: bold; color: #008080; font-size: 16px; }
        .pay-remarks { font-size: 11px; color: #666; font-style: italic; margin-top: 3px; }
        
        input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 18px; text-align: center; text-transform: uppercase; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: #008080; box-shadow: 0 0 0 3px rgba(0,128,128,0.1); }
        
        button.btn-main { width: 100%; padding: 15px; border: none; border-radius: 10px; background: #008080; color: white; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button.btn-main:active { transform: scale(0.98); }
        
        .loading-spinner { text-align: center; padding: 40px; color: #888; display: none; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="initLoader" class="loading-overlay">
        <i class="fas fa-circle-notch fa-spin" style="font-size: 40px; color: #008080; margin-bottom: 20px;"></i>
        <p style="color: #666; font-weight: bold;">Starting KADAMAY...</p>
    </div>

    <div id="loginScreen" class="login-card" style="display:none;">
        <h1 style="color:#008080; font-size: 28px; margin-bottom: 5px;">KADAMAY</h1>
        <p style="color:#666; margin-bottom:30px">Online Member Portal</p>
        
        <input type="text" id="serialInput" placeholder="ENTER SERIAL ID">
        <button class="btn-main" id="btnVerify" onclick="verifyMember(false)">LOGIN</button>
        <p id="loginError" style="color:red; font-size:13px; margin-top:15px; display:none;"></p>
        
        <p style="font-size: 11px; color: #999; margin-top: 30px;">Enter your ID once to stay logged in.</p>
    </div>

    <div id="dashboardScreen" class="dashboard">
        <div class="header">
            <div class="top-nav">
                <button class="btn-close" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                
                <button class="btn-notif" onclick="clearNotif()">
                    <i class="fas fa-bell"></i>
                    <span id="notifBadge" class="badge-dot"></span>
                </button>
            </div>
            <div class="profile-info">
                <h1 id="dashName">...</h1>
                <p id="dashSerial">...</p>
                <span id="dashStatus" class="status-badge">...</span>
            </div>
        </div>

        <div class="content">
            <div class="section-title">
                <span><i class="fas fa-history" style="color:#008080; margin-right: 5px;"></i> Payment History</span>
                <button class="btn-refresh" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <p id="payCount" style="font-size:12px; color:#888; margin-top:-10px; margin-bottom:15px">Synced just now</p>

            <div id="loading" class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Loading Payments...</div>
            <div id="paymentList"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://ougkeltvpikpimyqexjc.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_el2jm7Ejz4qDJ4igRZ0mJw_jNEpXJdl'; 
        // ---------------------

        const { createClient } = supabase;
        const _db = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentMemberID = 0;
        let realtimeChannel = null;

        // --- 1. AUTO-LOGIN ON START ---
        window.onload = function() {
            // Check Local Storage
            const savedSerial = localStorage.getItem('kadamay_serial');
            
            if (savedSerial) {
                // Auto Login
                document.getElementById('serialInput').value = savedSerial;
                verifyMember(true); // true = auto mode
            } else {
                // Show Login Screen
                document.getElementById('initLoader').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
            }
        };

        // --- 2. VERIFY / LOGIN ---
        async function verifyMember(isAuto) {
            const input = document.getElementById('serialInput').value.trim();
            const btn = document.getElementById('btnVerify');
            const err = document.getElementById('loginError');

            if (!input) { 
                if(!isAuto) alert("Please enter Serial!"); 
                return; 
            }

            if(!isAuto) btn.innerText = "VERIFYING...";
            err.style.display = 'none';

            try {
                let { data, error } = await _db
                    .from('tbl_members')
                    .select('membersid, surname, name, isactive, memserial')
                    .eq('memserial', input)
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    // SUCCESS LOGIN
                    const member = data[0];
                    
                    // SAVE TO MEMORY (Local Storage)
                    localStorage.setItem('kadamay_serial', member.memserial);
                    
                    currentMemberID = member.membersid;
                    loadDashboard(member);
                } else {
                    // FAIL
                    localStorage.removeItem('kadamay_serial'); // Clear invalid data
                    document.getElementById('initLoader').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'block';
                    
                    err.innerText = "Serial not found.";
                    err.style.display = 'block';
                    btn.innerText = "LOGIN";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('initLoader').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                err.innerText = "Connection Error.";
                err.style.display = 'block';
                btn.innerText = "LOGIN";
            }
        }

        async function loadDashboard(member) {
            // Hide Loaders/Login
            document.getElementById('initLoader').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';

            // UI Updates
            document.getElementById('dashName').innerText = member.surname + ", " + member.name;
            document.getElementById('dashSerial').innerText = "ID: " + member.memserial;
            
            const statusEl = document.getElementById('dashStatus');
            if (member.isactive) {
                statusEl.innerText = "ACTIVE MEMBER";
                statusEl.style.color = "#008080";
            } else {
                statusEl.innerText = "INACTIVE";
                statusEl.style.color = "red";
            }

            fetchPayments(member.membersid);
            subscribeToRealtime(member.membersid);
        }

        // --- 3. LOGOUT (CLEAR MEMORY) ---
        function logout() {
            if(confirm("Are you sure you want to logout?")) {
                // Clear Memory
                localStorage.removeItem('kadamay_serial');
                
                // Stop Realtime
                if (realtimeChannel) _db.removeChannel(realtimeChannel);
                
                // Reset UI
                document.getElementById('dashboardScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('serialInput').value = "";
                document.getElementById('btnVerify').innerText = "LOGIN";
            }
        }

        function refreshData() {
            if(currentMemberID > 0) fetchPayments(currentMemberID);
        }

        async function fetchPayments(id) {
            const list = document.getElementById('paymentList');
            const loader = document.getElementById('loading');
            const count = document.getElementById('payCount');
            
            list.innerHTML = "";
            loader.style.display = 'block';

            try {
                let { data, error } = await _db
                    .from('qrycontribution') 
                    .select('dtepaid, receiptno, amount, payment_remarks')
                    .eq('membersid', id)
                    .order('dtepaid', { ascending: false });

                if (error) throw error;

                loader.style.display = 'none';
                count.innerText = (data ? data.length : 0) + " Records Found";

                if (data && data.length > 0) {
                    data.forEach(pay => {
                        const d = new Date(pay.dtepaid);
                        const dateStr = d.toLocaleDateString();
                        const remarks = pay.payment_remarks || '';

                        const item = document.createElement('div');
                        item.className = 'payment-card';
                        item.innerHTML = `
                            <div class="pay-left">
                                <span class="pay-or">OR# ${pay.receiptno || 'N/A'}</span>
                                <span class="pay-date">${dateStr}</span>
                                <span class="pay-remarks">${remarks}</span>
                            </div>
                            <div class="pay-right">
                                â‚±${(pay.amount || 0).toLocaleString()}
                            </div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    list.innerHTML = '<p style="text-align:center; color:#999; margin-top:30px; font-size:13px">No payment history found.</p>';
                }

            } catch (e) {
                alert("Error loading payments: " + e.message);
                loader.style.display = 'none';
            }
        }

        function subscribeToRealtime(id) {
            if (realtimeChannel) _db.removeChannel(realtimeChannel);
            realtimeChannel = _db
                .channel('payment-updates')
                .on(
                    'postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'tbl_contribution', filter: 'membersid=eq.' + id }, 
                    (payload) => {
                        playSound();
                        document.getElementById('notifBadge').style.display = 'block';
                        refreshData();
                    }
                )
                .subscribe();
        }

        function playSound() {
            const audio = document.getElementById('notifSound');
            audio.play().catch(e => {});
        }

        function clearNotif() {
            document.getElementById('notifBadge').style.display = 'none';
            alert("System is up to date.");
        }
    </script>
</body>
</html>